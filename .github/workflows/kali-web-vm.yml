name: VM-Web
on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  vm:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: Instalar dependencias
      run: |
        sudo apt update
        sudo apt install -y qemu-kvm qemu-utils novnc websockify x11-apps

    - name: Descargar imagen de la VM (Ubuntu Mini)
      run: |
        wget https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img -O disk.img
        qemu-img resize disk.img +8G

    - name: Instalar y conectar Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey ${{ secrets.TS_KEY }} --hostname github-vm

    - name: Iniciar servidor noVNC
      run: |
        mkdir -p ~/.vnc
        websockify 6080 --web=/usr/share/novnc/ &
        echo "noVNC listo en puerto 6080"

    - name: Iniciar VM con interfaz gr√°fica
      run: |
        qemu-system-x86_64 \
          -m 4096 \
          -smp 2 \
          -drive file=disk.img,if=virtio \
          -enable-kvm \
          -vnc :0 \
          -device virtio-net,netdev=n0 \
          -netdev user,id=n0,hostfwd=tcp::2222-:22 \
          -usb -device usb-tablet &
        echo "VM iniciada"

    - name: Mantener workflow vivo
      run: |
        echo "Servidor vivo..."
        sleep 21600
